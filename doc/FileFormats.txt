Ultima 4 File Structures
========================

$Id$

Please send additions, corrections and feedback to
<andrewtaylor@users.sourceforge.net>!


SHAPES.EGA
----------

This contains the bitmaps for each tile.  Each tile is 16x16 pixels,
and each byte represents two pixels.  In other words, the first 8
bytes represent the 16 pixels on the first row of the first tile.

offset  len  notes
0x0     128  tile 0
0x80    128  tile 1
0x100   128  tile 2
...
0x7F80  128  tile 255


CHARSET.EGA
-----------

This contains the bitmaps for each character in the font.  Each
character is 8x8 pixels, and each byte represents two pixels.  In
other words, the first 4 bytes represent the 8 pixels on the first row
of the first character.  The order is the standard ASCII mapping; 'A'
is character 65, 'z' is character 122.

offset  len  notes
0x0     32   character 0
0x20    32   character 1
0x40    32   character 2
...
0x1FC0  32   character 255


.EGA files (RLE encoded)
------------------------

The following .EGA files are RLE encoded: START.EGA, KEY7.EGA,
RUNE_x.EGA (where x is between 0 and 5), STONCRCL.EGA, HONESTY.EGA,
COMPASSN.EGA, VALOR.EGA, JUSTICE.EGA, SACRIFIC.EGA, HONOR.EGA,
SPIRIT.EGA, HUMILITY.EGA, TRUTH.EGA, LOVE.EGA, and COURAGE.EGA.  Each
of these files represents a 16 color 320x200 bitmap.  Each pixel is
encoded in 4 bits, like SHAPES.EGA and CHARSET.EGA.  However, runs of
identical *bytes* (not pixels) are encoded with a special run
indicator value (0x02) followed by a one byte count and a one byte
value.  This allows a single run of up to 255 bytes (510 pixels) to be
represented as three bytes.  For example, the byte values "28 28 28
28" could be represented as "02 04 28".  If the value 0x02 needs to be
represented, it *must* be encoded in a run ("02 01 02").

file         purpose
START.EGA    the basic game borders
KEY7.EGA     shown when the key is used
RUNE_0.EGA   vision shown after meditating on valor
RUNE_1.EGA   vision shown after meditating on honesty, justice, and honor
RUNE_2.EGA   vision shown after meditating on compassion and sacrifice
RUNE_3.EGA   vision shown after meditating on spirituality
RUNE_4.EGA   vision shown after meditating on humility
RUNE_5.EGA
STONCRCL.EGA shown when game completed
HONESTY.EGA  shown during questioning in abyss
COMPASSN.EGA shown during questioning in abyss
VALOR.EGA    shown during questioning in abyss
JUSTICE.EGA  shown during questioning in abyss
SACRIFIC.EGA shown during questioning in abyss
HONOR.EGA    shown during questioning in abyss
SPIRIT.EGA   shown during questioning in abyss
HUMILITY.EGA shown during questioning in abyss
TRUTH.EGA    shown during questioning in abyss
LOVE.EGA     shown during questioning in abyss
COURAGE.EGA  shown during questioning in abyss


.EGA files (LZW encoded)
------------------------

The remaining .EGA files are LZW encoded: ABACUS.EGA, ANIMATE.EGA,
GYPSY.EGA, INSIDE.EGA, OUTSIDE.EGA, PORTAL.EGA, TREE.EGA, WAGON.EGA,
HONCOM.EGA, SACHONOR.EGA, SPIRHUM.EGA, VALJUS.EGA, and TITLE.EGA.
Also, the file SHAPES.EGZ is a LZW compressed version of SHAPES.EGA.
Like the RLE encoded files, each of these files represents a 16 color
320x200 bitmap.  LZW encoded files only seem to be used in the
introduction sequence (title.exe); the images used by avatar.exe are
RLE encoded instead.  (Description of LZW algorithm to go here).

file         purpose
TITLE.EGA    the background for the inital screen, including the large Ultima IV and
             the border for the map/menu
ANIMATE.EGA  the frames for the little critters in the upper corners of the intro
             screen
TREE.EGA     initial graphic for character creation sequence (has animated moongate)
PORTAL.EGA   closeup of the moongate
OUTSIDE.EGA  the faire from outside
INSIDE.EGA   inside the faire
WAGON.EGA    the gyspy's wagon
GYPSY.EGA    the gypsy herself
ABACUS.EGA   the abacus that serves as the background while the questions are asked
HONCOM.EGA   the cards for honor and compassion
VALJUS.EGA   the cards for valor and justice
SACHONOR.EGA the cards for sacrifice and honor
SPIRHUM.EGA  the cards for spirituality and humility


WORLD.MAP
---------

This is the map of Britannia. It is 256x256 tiles in total, broken up
into 64 32x32 chunks.  The first chunk is in the top left corner, the
next just below, and so on, until the last in the bottom right corner.
Each tile is stored as a byte that maps to the tiles in SHAPES.EGA.

The "chunked" layout is an artifact of the limited memory on the
original machines that ran Ultima 4.  The whole map would take 64k,
too much for a C64 or an Apple II, so the game would keep a limited
number of 1k chunks in memory at a time.  As the player moved around,
old chunks were thrown out as new ones were swapped in.

offset len  notes
0x0    1024 32x32 map matrix for chunk 0
0x400  1024 32x32 map matrix for chunk 1
...
0xFC00 1024 32x32 map matrix for chunk 63


.ULT files
----------

These contain town information.  Specifically, a 32x32 map, plus the
starting position, movement behavior, and conversation index of each
NPC.  The conversation index gives the starting position of the NPC's
dialog block in the cooresponding .TLK file.  I'm not sure why some of
the data is duplicated.

offset len  notes
0x0    1024 32x32 town map matrix
0x400  32   tile for NPCs 0-31
0x420  32   start_x for NPCs 0-31
0x440  32   start_y for NPCs 0-31
0x460  32   repitition of 0x400-0x41F
0x480  32   repitition of 0x420-0x43F
0x4A0  32   repitition of 0x440-0x45F
0x4C0  32   movement_behavior for NPCs 0-31 (0x0-fixed, 0x1-wander, 0x80-follow, 0xFF-attack)
0x4E0  32   conversion index (tlk file) for NPCs 0-31


.TLK files
----------

These contain conversation information.  The file has a 288 (0x120)
byte block containing his or her dialogues, plus the words that
trigger his or her responses (keywords).  Most of the fields are
variable length strings terminated by a single zero byte and the
following field starts immediately after.  The blocks are padded
with zero bytes to 288 bytes.

0x0    1    NPC 0 question flag (0-no question, 3-job triggers, 4-health
            triggers, 5-keyword 1 triggers, 6-keyword 2 triggers)
0x1    1    NPC 0 question type (0-should answer yes, 0-should answer no)
0x2    1    NPC 0 turns away probability
0x3    var  NPC 0 name (zero terminated)
var    var  NPC 0 pronoun (zero terminated)
var    var  NPC 0 description (zero terminated)
var    var  NPC 0 job (zero terminated)
var    var  NPC 0 response 1 (zero terminated)
var    var  NPC 0 response 2 (zero terminated)
var    var  NPC 0 question (zero terminated)
var    var  NPC 0 yes answer (zero terminated)
var    var  NPC 0 no answer (zero terminated)
var    5    NPC 0 keyword 1 (zero terminated)
var    5    NPC 0 keyword 2 (zero terminated)
var    var  zero padding
0x120  3    NPC 1 question flag
...


.CON files
----------

These files contain the 11x11 battleground maps shown when combat
starts.  It has the map itself plus starting positions for up to 16
monsters and 8 party members.

offset len  notes
0x0    16   start_x for monsters 0-15
0x10   16   start_y for monsters 0-15
0x20   8    start_x for party members 0-7
0x28   8    start_y for party members 0-7
0x30   16   ???
0x40   121  11x11 map matrix
0xB9   7    ???


.DNG files
----------

These files contain dungeon information.  The first 512 bytes are the
8x8 maps for each of the 8 levels.  These are used for the dungeons 3D
mode.  The rest of the file is a set of 16 (64 in the case of the
ABYSS.DNG) 256 byte blocks that define the dungeon rooms.

offset len  notes
0x0    64   level 1 8x8 map matrix
0x40   64   level 2 8x8 map matrix
0x80   64   level 3 8x8 map matrix
0xA0   64   level 4 8x8 map matrix
0x100  64   level 5 8x8 map matrix
0x140  64   level 6 8x8 map matrix
0x180  64   level 7 8x8 map matrix
0x1A0  64   level 8 8x8 map matrix
0x200  16   room 0 ??? (often 0x0)
0x210  16   room 0 tile for monsters 0-15
0x220  16   room 0 start_x for monster 0-15
0x230  16   room 0 start_y for monster 0-15
0x240  8    room 0 start_x for party member 0-7 (north entry)
0x248  8    room 0 start_y for party member 0-7 (north entry)
0x250  8    room 0 start_x for party member 0-7 (east entry)
0x258  8    room 0 start_y for party member 0-7 (east entry)
0x260  8    room 0 start_x for party member 0-7 (south entry)
0x268  8    room 0 start_y for party member 0-7 (south entry)
0x270  8    room 0 start_x for party member 0-7 (west entry)
0x278  8    room 0 start_y for party member 0-7 (west entry)
0x280  121  room 0 11x11 map matrix
0x2F9  7    room 0 ??? (often 0x0)
0x300  16   room 1 ??? (often 0x0)
0x310  16   room 1 tile for monsters 0-15
...
0x1780 121  room 15 11x11 map matrix
0x17F9 7    room 15 ??? (often 0x0)


PARTY.SAV
---------

This file stores the information that is stored when the game is
saved.  It includes party-wide information like gold and food, plus a
39 byte record for each character.

Things that might be in here, but haven't been verified:
 - amount of time elapsed since last action (offset 0x0?)
 - whether the skull has been destroyed (bit 2 on 0x1D1?)
 - which dungeon orbs have been used
 - location of balloon
 - direction of the wind

offset len  notes
0x0    4    ???
0x4    2    moves (low word)
0x6    2    moves (high word)
0x8    39   player 0 record
0x2F   39   player 1 record
0x56   39   player 2 record
0x7D   39   player 3 record
0xA4   39   player 4 record
0xCB   39   player 5 record
0xF2   39   player 6 record
0x119  39   player 7 record
0x140  4    food (in units of hundredths)
0x144  2    gold
0x146  16   karma (2 bytes each for honesty, compassion, valor, justice,
            sacrifice, honor, spirituality and humility; 0-partial avatar)
0x156  2    torches
0x158  2    gems
0x15A  2    keys
0x15C  2    sextants
0x16E  16   armor (2 bytes each for none (unused), cloth, leather, chain,
            plate, magic chain, magic plate, mystic robes)
0x16E  32   weapons (2 bytes each for none (unused), staves, daggers,
            slings, maces, axes, swords, bows, crossbows, oil, halberds,
            magic axes, magic swords, magic bows, magic wands, mystic
            swords)
0x18E  16   reagents (2 bytes each for sulfurous ash, ginseng, garlic,
            spider silk, blood moss, black pearl, nightshade, mandrake)
0x19E  52   mixtures (2 bytes each for awaken, blink, cure, dispel,
            energy, fireball, gate, heal, iceball, jinx, kill, light,
            magic missile, negate, open, protection, quickness,
            resurrect, sleep, tremor, undead, view, winds, x-it, y-up,
            z-down)
0x1D2  1    items (1 bit each for skull, skull destroyed, candle, book,
            bell, key part C, key part L, key part T)
0x1D3  1    items (1 bit each for horn, wheel, candle used at abyss 
            entrance, book used at abyss entrance, bell used at abyss
            entrance, (3 bits unused))
0x1D4  1    x coord
0x1D5  1    y coord
0x1D6  1    stones (1 bit each for BYRGOPWB)
0x1D7  1    runes (1 bit each for HCVJSHSH)
0x1D8  2    number of characters in party
0x1DA  2    transport (0x10-ship facing west, 0x11-ship facing north,
            0x12-ship facing east, 0x13-ship facing south, 0x14-horse
            facing west, 0x15-horse facing east, 0x18-balloon, 0x1f-on
            foot)
0x1DC  2    balloon status (0-on ground, 1-flying (?verify?))
0x1DE  6    ???
0x1E4  1    introduced to Lord British (0-haven't been introduced, 1-introduced)
0x1E5  9    ???
0x1EE  2    ??? (coordinates of a dungeon)
0x1F0  2    orientation in dungeon (0-west, 1-north, 2-east, 3-south)
0x1F2  2    dungeon level (starting at zero)
0x1F4  2    ???

The character record format:

offset len  notes
0x0    2    hit points
0x2    2    hit points maximum
0x4    2    experience points
0x6    2    strength
0x8    2    dex
0xA    2    int
0xC    2    mp
0xE    2    ???
0x10   2    weapon
0x12   2    armor
0x14   16   name
0x24   1    sex (0xb-male, 0xc-female)
0x25   1    class
0x26   1    status ('G'-good, 'P'-poisoned, 'S'-sleeping, 'D'-dead)


TITLE.EXE
---------

This executable is launched by ultima.com to display the introduction
and create new characters.  When "journey onward" is selected from the
intro menu, it exits and ultima.com passes control off to avatar.exe,
the main game executable.  This .exe has lots of the data necessary
for the intro screens embedded in it.

offset len   notes
0x0    17445 ???
0x4425 11088 text for introduction, gypsy dialog and gyspy questions
             (zero terminated strings)
0x6f75 1035  ???
0x7380 184   list of frames sequences for beasties on intro screen
0x7438 54    ???
0x746e 532   266 x/y pairs that are the coordinates for the pixels that
             make up the Lord British signature on the introductory
             title screen
0x7682 1     zero terminating byte
0x7683 95    tile values for the 19x5 map that appears on the
             introductory title screen
0x76e2 ...   ???


AVATAR.EXE
----------

This is the main game executable, launched from ultima.com (or run on
its own to skip the intro).  Lots of the special case data is embedded
in this .exe.

offset  len   notes
0x0     74729 ???
0x123e9 3485  Hawkwind dialog text; the first 40 zero terminated
              strings are his responses for 5 levels times 8 virtures,
              plus some other miscellaneous dialog strings
0x13186 645   ??? 
0x1340b 24    price for each of the first five reagents at Moonglow,
              Skara Brae, Paws, and Buccaneers Den respectively (one
              byte per price)
0x13423 1273  weapon vendor dialog text; 28 zero terminated strings
0x1391c 25    ??? 
0x13935 24    which four weapons each of the six weapons vendors can
              sell (one byte per weapon)
0x1394d 32    price of each weapon (two bytes for each price)
0x1396d 45    ???
0x1399a 497   more weapon vendor dialog text; 27 zero terminated strings
0x13b8b 24    ???
0x13ba3 646   armor vendor dialog text; 19 zero terminated strings
0x13e29 22    ???
0x13e3f 20    which four types of armor each of the five armor vendors
              can sell (one byte per armor type)
0x13e53 4     zero padding
0x13e57 16    price of each type of armor (two bytes for each price)
0x13e67 29    ???
0x13e84 482   more armor vendor dialog text; 27 zero terminated strings
0x14066 5559  ???
0x1561d 172   Lord British dialog keywords; 24 zero terminated strings
0x156c9 1     zero terminating byte
0x156ca 2967  Lord British dialog text; 24 zero terminated strings
              (responses for above keywords)
0x16261 ...


Sources
-------

http://www.geocities.com/xenerkes/
http://www.moongates.com/u4/Tech.asp
